<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article ‚Äì Qualit√© village Melen</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0}
    header, footer{background:#2f6f5e;color:#fff;padding:12px}
    nav a{color:#fff;margin-right:10px;text-decoration:none}
    main{padding:18px;max-width:900px;margin:0 auto}
    .article-meta{color:#666;margin-top:12px}
    .article-fragment img{max-width:100%;height:auto;border-radius:6px}
    .article-nav a{margin-right:8px}
  </style>
</head>
<body>

<header>
  <h1>Groupement Intercommunal</h1>
  <nav>
    <a href="index.html">Actualit√©s</a>
    <a href="articles.html">Articles</a>
    <a href="carte.html">Carte</a>
    <a href="agenda.html">Agenda</a>
    <a href="contact.html">Contacts</a>
  </nav>
</header>

<main id="articleRoot">
  <p>Chargement de l‚Äôarticle‚Ä¶</p>
</main>

<footer>
  <p>¬© 2025 ‚Äì Qualit√© village Melen</p>
</footer>

<script>
(async function(){
  const esc = s => String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');

  const params = new URLSearchParams(location.search);
  const fileParam = params.get('file');
  const idParam = params.get('id');

  try {
    const [articlesRes, optionsRes] = await Promise.all([
      fetch('articles.json'),
      fetch('options.json')
    ]);

    const articles = await articlesRes.json();
    const options = await optionsRes.json();

    /* ===== Trouver l‚Äôarticle ===== */
    let article = null;
    if (fileParam) {
      article = articles.find(a => a.file === fileParam);
    } else if (idParam && !isNaN(idParam)) {
      article = articles[Number(idParam)];
    }

    if (!article) {
      document.getElementById('articleRoot').innerHTML = '<p>Article non trouv√©.</p>';
      return;
    }

    /* ===== Charger le fragment HTML ===== */
    let fragmentHtml = '';
    try {
      const res = await fetch('articles/content/' + article.file);
      if (res.ok) fragmentHtml = await res.text();
    } catch(e){}

    if (!fragmentHtml) {
      fragmentHtml = `<p>Contenu manquant (articles/content/${esc(article.file)})</p>`;
    }

    /* ===== R√©solution des m√©tadonn√©es ===== */

    // ---- RUE / LIEU (nouveau format + r√©trocompatibilit√©)
    let rue = '';
    let rueId = '';

    if (article.rueId != null && Array.isArray(options.rues)) {
      // cas index num√©rique
      if (!isNaN(article.rueId) && options.rues[Number(article.rueId)]) {
        const r = options.rues[Number(article.rueId)];
        rue = r.nom;
        rueId = r.id;
      }
      // cas id string
      else {
        const found = options.rues.find(r => r.id === article.rueId);
        if (found) {
          rue = found.nom;
          rueId = found.id;
        }
      }
    }

    const periode =
      article.periode != null && options.periodes?.[article.periode]
        ? options.periodes[article.periode]
        : '';

    const famille =
      article.famille != null && options.familles?.[article.famille]
        ? options.familles[article.famille]
        : '';

    const theme =
      article.theme != null && options.themes?.[article.theme]
        ? options.themes[article.theme]
        : '';

    /* ===== M√©tadonn√©es ===== */
    const meta = [];
    if (rue) meta.push(`<a href="carte.html?rue=${encodeURIComponent(rueId)}">üìç ${esc(rue)}</a>`);
    if (periode) meta.push(`üï∞ ${esc(periode)}`);
    if (famille) meta.push(`üë®‚Äçüë©‚Äçüëß ${esc(famille)}`);
    if (theme) meta.push(`üè∑ ${esc(theme)}`);

    /* ===== Injection propre ===== */
    const root = document.getElementById('articleRoot');
    root.innerHTML = `
      ${fragmentHtml}
      <div class="article-meta">${meta.join(' ‚Ä¢ ')}</div>
      <p class="article-nav">
        <a href="articles.html">‚Üê Retour aux articles</a>
      </p>
    `;

  } catch(err) {
    console.error(err);
    document.getElementById('articleRoot').innerHTML = '<p>Erreur de chargement.</p>';
  }
})();
</script>

</body>
</html>
