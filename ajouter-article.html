<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ajouter / Modifier un article – Melen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<script>
/* ===== LOGIN SIMPLE ===== */
const PASSWORD = "melen1943";
if (prompt("Mot de passe requis") !== PASSWORD) {
  document.body.innerHTML = "<h2 style='text-align:center;margin-top:3rem;'>Accès refusé</h2>";
  throw new Error("Accès refusé");
}
</script>

<style>
body { font-family: sans-serif; margin: 2rem; max-width: 900px }
.form-group { margin-bottom: 1rem }
label { font-weight: bold; display:block; margin-bottom:.3rem }
input, select, textarea { width:100%; padding:.5rem }
button { margin-top:.5rem; padding:.6rem 1rem; cursor:pointer }
.preview img, video { max-width:100%; margin-top:1rem; border-radius:6px }
textarea { font-family: monospace }
</style>
</head>

<body>

<h1>Ajouter / Modifier un article</h1>

<div class="form-group">
  <label>Article existant</label>
  <select id="articleSelect">
    <option value="">— Nouvel article —</option>
  </select>
</div>

<div class="form-group">
  <label>Titre</label>
  <input id="title">
</div>

<div class="form-group">
  <label>Nom du fichier HTML</label>
  <input id="file" placeholder="Article-mon-article.html">
</div>

<div class="form-group">
  <label>Rue</label>
  <select id="rueId"></select>
</div>

<div class="form-group">
  <label>Période</label>
  <select id="periode"></select>
</div>

<div class="form-group">
  <label>Famille</label>
  <select id="famille">
    <option value="">— Aucune —</option>
  </select>
</div>

<div class="form-group">
  <label>Thème</label>
  <select id="theme"></select>
</div>

<div class="form-group">
  <label>Image (optionnel)</label>
  <input id="image" placeholder="images/photo.jpg">
</div>

<div class="form-group">
  <label>Vidéo mp4 (optionnel)</label>
  <input id="video" placeholder="videos/video.mp4">
</div>

<div class="form-group">
  <label>Texte HTML de l’article</label>
  <textarea id="content" rows="10"></textarea>
</div>

<button onclick="generate()">Générer fichiers</button>

<hr>

<h3>JSON article</h3>
<textarea id="jsonOutput" rows="10"></textarea>

<h3>HTML article</h3>
<textarea id="htmlOutput" rows="15"></textarea>

<div id="downloads"></div>

<script>
let options, articles;
let currentIndex = null;

/* ===== CHARGEMENT DES DONNÉES ===== */
(async function init() {
  [options, articles] = await Promise.all([
    fetch('options.json').then(r=>r.json()),
    fetch('articles.json').then(r=>r.json())
  ]);

  fillSelect('rueId', options.rues.map(r=>r.nom));
  fillSelect('periode', options.periodes);
  fillSelect('famille', options.familles, true);
  fillSelect('theme', options.themes);

  populateArticleSelect();
})();

/* ===== UTILITAIRES ===== */
function fillSelect(id, arr, allowEmpty=false) {
  const sel = document.getElementById(id);
  sel.innerHTML = '';
  if (allowEmpty) {
    const o = document.createElement('option');
    o.value = '';
    o.textContent = '— Aucune —';
    sel.appendChild(o);
  }
  arr.forEach((txt, i) => {
    const o = document.createElement('option');
    o.value = i;
    o.textContent = txt;
    sel.appendChild(o);
  });
}

function populateArticleSelect() {
  const sel = document.getElementById('articleSelect');
  articles.forEach((a,i) => {
    const o = document.createElement('option');
    o.value = i;
    o.textContent = a.title;
    sel.appendChild(o);
  });
  sel.onchange = () => loadArticle(sel.value);
}

/* ===== CHARGER ARTICLE ===== */
function loadArticle(i) {
  if (i === "") {
    currentIndex = null;
    document.querySelectorAll('input,textarea,select').forEach(e=>e.value="");
    return;
  }
  currentIndex = Number(i);
  const a = articles[currentIndex];
  title.value = a.title;
  file.value = a.file;
  rueId.value = a.rueId ?? '';
  periode.value = a.periode;
  famille.value = a.famille ?? '';
  theme.value = a.theme;
  image.value = a.image ?? '';
  video.value = a.video ?? '';
  content.value = '';
}

/* ===== GÉNÉRATION ===== */
function generate() {
  const article = {
    title: title.value,
    file: file.value,
    rueId: rueId.value !== "" ? Number(rueId.value) : null,
    periode: Number(periode.value),
    famille: famille.value !== "" ? Number(famille.value) : null,
    theme: Number(theme.value),
    image: image.value || null,
    video: video.value || null
  };

  if (currentIndex !== null) {
    articles[currentIndex] = article;
  } else {
    articles.push(article);
  }

  const articleHTML = `
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>${article.title}</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<article class="article-fragment">
  <section>
    <h2>${article.title}</h2>
    <p class="date">${options.themes[article.theme]}</p>
  </section>

  ${article.image ? `<figure><img src="${article.image}"></figure>` : ''}
  ${article.video ? `<video controls src="${article.video}"></video>` : ''}

  <section class="article-body">
${content.value}
  </section>
</article>

</body>
</html>`.trim();

  jsonOutput.value = JSON.stringify(article, null, 2);
  htmlOutput.value = articleHTML;

  downloads.innerHTML = `
    <a download="${article.file}" href="data:text/html;charset=utf-8,${encodeURIComponent(articleHTML)}">⬇ HTML</a>
    <a download="articles.json" href="data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(articles,null,2))}">⬇ articles.json</a>
  `;
}
</script>

</body>
</html>
