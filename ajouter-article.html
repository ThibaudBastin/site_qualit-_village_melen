<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ajouter / modifier un article</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">

<script>
const PASSWORD = "melen1943";
if (prompt("Mot de passe requis :") !== PASSWORD) {
  document.write("<h2 style='text-align:center;margin-top:3rem;'>Acc√®s refus√©</h2>");
  throw new Error("Acc√®s refus√©");
}
</script>

<style>
body { font-family: Arial, sans-serif; max-width: 1000px; margin: auto; padding: 1rem; }
.form-group { margin-bottom: 1rem; }
label { font-weight: bold; display:block; margin-bottom: .3rem; }
input, textarea, select { width:100%; padding:.5rem; }
button { margin-top:.5rem; padding:.6rem 1rem; }
.figure-row { border:1px solid #ddd; padding:.5rem; margin-bottom:.5rem; }
iframe { width:100%; height:600px; border:1px solid #ccc; margin-top:1rem; }
hr { margin:2rem 0; }
.new-option { margin-top:.3rem; display:flex; gap:.5rem; }
</style>
</head>
<body>

<h1>Ajouter / modifier un article</h1>

<div class="form-group">
<label>Article existant</label>
<select id="articleSelect">
<option value="">‚Äî Nouvel article ‚Äî</option>
</select>
</div>

<hr>

<div class="form-group">
<label>Titre</label>
<input id="title">
</div>

<div class="form-group">
<label>Description (ligne sous le titre)</label>
<input id="description">
</div>

<div class="form-group">
<label>Nom du fichier fragment</label>
<input id="file" placeholder="Article-mon-article.html">
</div>

<!-- Options dynamiques -->
<div class="form-group">
<label>Rue</label>
<select id="rueId"></select>
<div class="new-option">
<input id="newRue" placeholder="Nouvelle rue">
<button onclick="addOption('rues')">‚ûï Ajouter</button>
</div>
</div>

<div class="form-group">
<label>P√©riode</label>
<select id="periode"></select>
<div class="new-option">
<input id="newPeriode" placeholder="Nouvelle p√©riode">
<button onclick="addOption('periodes')">‚ûï Ajouter</button>
</div>
</div>

<div class="form-group">
<label>Famille</label>
<select id="famille"></select>
<div class="new-option">
<input id="newFamille" placeholder="Nouvelle famille">
<button onclick="addOption('familles')">‚ûï Ajouter</button>
</div>
</div>

<div class="form-group">
<label>Th√®me</label>
<select id="theme"></select>
<div class="new-option">
<input id="newTheme" placeholder="Nouveau th√®me">
<button onclick="addOption('themes')">‚ûï Ajouter</button>
</div>
</div>

<hr>

<h3>Lieux (pour carte)</h3>
<div id="lieux"></div>
<button onclick="addLieu()">‚ûï Ajouter un lieu</button>

<hr>

<h3>Images</h3>
<div id="figures"></div>
<button onclick="addFigure()">‚ûï Ajouter une image</button>

<hr>

<div class="form-group">
<label>Corps de l‚Äôarticle</label>
<textarea id="body" rows="10" placeholder="Un paragraphe = une ligne vide"></textarea>
</div>

<button onclick="generate()">üíæ G√©n√©rer / mettre √† jour</button>

<hr>

<h3>Pr√©visualisation</h3>
<iframe id="preview"></iframe>

<hr>

<h3>Fragment HTML</h3>
<textarea id="htmlOut" rows="12"></textarea>

<h3>Entr√©e articles.json</h3>
<textarea id="jsonOut" rows="8"></textarea>

<h3>Options JSON</h3>
<textarea id="optionsOut" rows="8"></textarea>

<h3>Lieux JSON</h3>
<textarea id="lieuxOut" rows="8"></textarea>

<div id="downloads"></div>

<script>
let options = {};
let articles = [];
let lieux = [];
let currentIndex = null;

/* ===================== CHARGEMENT ===================== */
(async function(){
  [options, articles, lieux] = await Promise.all([
    fetch('options.json').then(r=>r.json()),
    fetch('articles.json').then(r=>r.json()),
    fetch('lieux.json').then(r=>r.json())
  ]);

  fillSelect('rueId', options.rues.map(r=>r.nom), true);
  fillSelect('periode', options.periodes);
  fillSelect('famille', options.familles, true);
  fillSelect('theme', options.themes);

  const sel = articleSelect;
  articles.forEach((a,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = a.title;
    sel.appendChild(o);
  });

  sel.onchange = () => loadArticle(sel.value);

  renderLieux();
})();

function fillSelect(id, arr, nullable=false){
  const s = document.getElementById(id);
  s.innerHTML = nullable ? `<option value="">‚Äî Aucun ‚Äî</option>` : '';
  arr.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=v;
    s.appendChild(o);
  });
}

/* ===================== AJOUT OPTIONS ===================== */
function addOption(type){
  const input = document.getElementById('new' + type.charAt(0).toUpperCase() + type.slice(1));
  const val = input.value.trim();
  if(!val) return;
  if(!options[type]) options[type]=[];
  options[type].push(val);
  input.value='';
  fillSelect(type==='rues'?'rueId':type, options[type], type!=='rues');
  optionsOut.value = JSON.stringify(options,null,2);
}

/* ===================== AJOUT LIEU ===================== */
function addLieu(){
  const name = prompt("Nom du lieu");
  if(!name) return;
  const id = prompt("ID unique (ex: rue-reux)");
  if(!id) return;
  const lat = parseFloat(prompt("Latitude"));
  const lng = parseFloat(prompt("Longitude"));
  if(isNaN(lat) || isNaN(lng)) return alert("Coordonn√©es invalides");
  lieux.push({id,name,coords:[lat,lng]});
  renderLieux();
  lieuxOut.value = JSON.stringify(lieux,null,2);
}

function renderLieux(){
  const container = document.getElementById('lieux');
  container.innerHTML = '';
  lieux.forEach((l,i)=>{
    const div=document.createElement('div');
    div.textContent=`${l.nom} (ID: ${l.id}) üìç [${l.coords.join(', ')}]`;
    container.appendChild(div);
  });
}

/* ===================== FIGURES ===================== */
function addFigure(src='', caption=''){
  const d=document.createElement('div');
  d.className='figure-row';
  d.innerHTML=`
    <input placeholder="Image (images/xxx.jpg)" value="${src}">
    <input placeholder="L√©gende" value="${caption}">
    <button onclick="this.parentElement.remove()">‚ùå</button>
  `;
  figures.appendChild(d);
}

/* ===================== LECTURE ARTICLE ===================== */
async function loadArticle(idx){
  if(idx==='') return;
  currentIndex = Number(idx);
  const a = articles[currentIndex];

  title.value = a.title;
  file.value = a.file;
  rueId.value = a.rueId ?? '';
  periode.value = a.periode;
  famille.value = a.famille ?? '';
  theme.value = a.theme;

  const path = 'articles/content/' + a.file;
  try {
    const res = await fetch(path);
    if (!res.ok) throw new Error(res.status);
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const section = doc.querySelector('.article-body');

    if(section){
      const dateP = section.querySelector('p.date');
      description.value = dateP ? dateP.innerText.trim() : '';

      const paragraphs = Array.from(section.querySelectorAll('p'))
                              .filter(p => !p.classList.contains('date'));
      body.value = paragraphs.map(p => p.innerText.trim()).join('\n\n');

      const figuresDiv = document.getElementById('figures');
      figuresDiv.innerHTML = '';
      section.querySelectorAll('figure').forEach(f => {
        const img = f.querySelector('img')?.getAttribute('src') || '';
        const caption = f.querySelector('figcaption')?.innerText || '';
        addFigure(img, caption);
      });
    } else {
      description.value = '';
      body.value = '';
      figures.innerHTML = '';
    }

    preview.srcdoc = buildPreview(html);

  } catch(e){
    alert("Fragment introuvable :\n" + path);
    console.error(e);
    body.value = '';
    description.value = '';
    figures.innerHTML = '';
  }
}

/* ===================== G√âN√âRATION ===================== */
function generate(){
  const figuresData = [...figures.children].map(d=>({
    src: d.children[0].value,
    caption: d.children[1].value
  }));

  const fragment = generateFragment({
    title: title.value,
    description: description.value,
    figures: figuresData,
    body: body.value
  });

  htmlOut.value = fragment;

  const jsonEntry = {
    title: title.value,
    file: file.value,
    rueId: rueId.value !== '' ? Number(rueId.value) : null,
    periode: Number(periode.value),
    famille: famille.value !== '' ? Number(famille.value) : null,
    theme: Number(theme.value),
    image: figuresData[0]?.src || null,
    video: null
  };

  jsonOut.value = JSON.stringify(jsonEntry,null,2);
  preview.srcdoc = buildPreview(fragment);

  downloads.innerHTML='';
  download(fragment, file.value, 'text/html');
  download(JSON.stringify(jsonEntry,null,2), file.value.replace('.html','.json'),'application/json');
  download(JSON.stringify(options,null,2), 'options.json','application/json');
  download(JSON.stringify(lieux,null,2), 'lieux.json','application/json');
}

/* ===================== HELPERS ===================== */
function generateFragment(d){
return `<article class="article-fragment">
  <section class="article-body">

    <h1>${d.title}</h1>

    ${d.description ? `<p class="date">${d.description}</p>` : ''}

    ${d.figures.map(f=>`
    <figure>
      <img src="${f.src}" alt="">
      ${f.caption ? `<figcaption>${f.caption}</figcaption>` : ''}
    </figure>`).join('\n')}

    ${d.body.split(/\n\s*\n/).map(p=>`<p>${p}</p>`).join('\n')}

  </section>
</article>`;
}

function buildPreview(fragment){
return `
<link rel="stylesheet" href="style.css">
<main style="max-width:900px;margin:auto">
${fragment}
</main>`;
}

function download(content,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name;
  a.click();
}
</script>
</body>
</html>
