<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ajouter / modifier un article</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="style.css">

<script>
const PASSWORD = "melen1943";
if (prompt("Mot de passe requis :") !== PASSWORD) {
  document.write("<h2 style='text-align:center;margin-top:3rem;'>Acc√®s refus√©</h2>");
  throw new Error("Acc√®s refus√©");
}
</script>

<style>
body{font-family:Arial,sans-serif;max-width:1000px;margin:auto;padding:1rem}
.form-group{margin-bottom:1rem}
label{font-weight:bold;display:block;margin-bottom:.3rem}
input,textarea,select{width:100%;padding:.5rem}
button{margin-top:.5rem;padding:.6rem 1rem}
.figure-row{border:1px solid #ddd;padding:.5rem;margin-bottom:.5rem}
iframe{width:100%;height:600px;border:1px solid #ccc;margin-top:1rem}
hr{margin:2rem 0}
.new-option{margin-top:.3rem;display:flex;gap:.5rem}
</style>
</head>
<body>

<h1>Ajouter / modifier un article</h1>

<div class="form-group">
<label>Article existant</label>
<select id="articleSelect">
<option value="">‚Äî Nouvel article ‚Äî</option>
</select>
</div>

<hr>

<div class="form-group">
<label>Titre</label>
<input id="title">
</div>

<div class="form-group">
<label>Description (ligne sous le titre)</label>
<input id="description">
</div>

<div class="form-group">
<label>Nom du fichier fragment</label>
<input id="file" placeholder="Article-mon-article.html">
</div>

<hr>

<!-- RUE -->
<div class="form-group">
<label>Rue</label>
<select id="rueId"></select>

<div class="new-option">
<input id="newRueNom" placeholder="Nom de la rue">
<input id="newRueId" placeholder="Identifiant (ex: rue-reux)">
<input id="newRueLat" placeholder="Latitude">
<input id="newRueLng" placeholder="Longitude">
<button onclick="addRue()">‚ûï Ajouter rue</button>
</div>
</div>

<!-- AUTRES OPTIONS -->
<div class="form-group">
<label>P√©riode</label>
<select id="periode"></select>
<div class="new-option">
<input id="newPeriode" placeholder="Nouvelle p√©riode">
<button onclick="addSimpleOption('periodes','newPeriode','periode')">‚ûï</button>
</div>
</div>

<div class="form-group">
<label>Famille</label>
<select id="famille"></select>
<div class="new-option">
<input id="newFamille" placeholder="Nouvelle famille">
<button onclick="addSimpleOption('familles','newFamille','famille')">‚ûï</button>
</div>
</div>

<div class="form-group">
<label>Th√®me</label>
<select id="theme"></select>
<div class="new-option">
<input id="newTheme" placeholder="Nouveau th√®me">
<button onclick="addSimpleOption('themes','newTheme','theme')">‚ûï</button>
</div>
</div>

<hr>

<h3>Images</h3>
<div id="figures"></div>
<button onclick="addFigure()">‚ûï Ajouter une image</button>

<hr>

<div class="form-group">
<label>Corps de l‚Äôarticle</label>
<textarea id="body" rows="10"></textarea>
</div>

<button onclick="generate()">üíæ G√©n√©rer</button>

<hr>

<h3>Pr√©visualisation</h3>
<iframe id="preview"></iframe>

<hr>

<h3>Fragment HTML</h3>
<textarea id="htmlOut" rows="10"></textarea>

<h3>Entr√©e articles.json</h3>
<textarea id="jsonOut" rows="8"></textarea>

<h3>Options.json</h3>
<textarea id="optionsOut" rows="8"></textarea>

<div id="downloads"></div>

<script>
let options={},articles=[],currentIndex=null;

/* ===================== CHARGEMENT ===================== */
(async function(){
  options = await fetch('options.json').then(r=>r.json());
  articles = await fetch('articles.json').then(r=>r.json());

  fillRues();
  fillSelect('periode',options.periodes);
  fillSelect('famille',options.familles,true);
  fillSelect('theme',options.themes);

  articles.forEach((a,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=a.title;
    articleSelect.appendChild(o);
  });

  articleSelect.onchange=()=>loadArticle(articleSelect.value);
})();

function fillRues(){
  rueId.innerHTML='<option value="">‚Äî Aucun ‚Äî</option>';
  options.rues.forEach((r,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=r.nom;
    rueId.appendChild(o);
  });
}

function fillSelect(id,arr,nullable=false){
  const s=document.getElementById(id);
  s.innerHTML=nullable?'<option value="">‚Äî Aucun ‚Äî</option>':'';
  arr.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=v;
    s.appendChild(o);
  });
}

/* ===================== AJOUT OPTIONS ===================== */
function addSimpleOption(type,inputId,selectId){
  const v=document.getElementById(inputId).value.trim();
  if(!v) return;
  options[type].push(v);
  document.getElementById(inputId).value='';
  fillSelect(selectId,options[type],selectId==='famille');
  optionsOut.value=JSON.stringify(options,null,2);
}

function addRue(){
  const nom=newRueNom.value.trim();
  const id=newRueId.value.trim();
  const lat=parseFloat(newRueLat.value);
  const lng=parseFloat(newRueLng.value);
  if(!nom||!id||isNaN(lat)||isNaN(lng)) return alert("Rue invalide");

  options.rues.push({id,nom,coords:[lat,lng]});
  newRueNom.value=newRueId.value=newRueLat.value=newRueLng.value='';
  fillRues();
  optionsOut.value=JSON.stringify(options,null,2);
}

/* ===================== FIGURES ===================== */
function addFigure(src='',caption=''){
  const d=document.createElement('div');
  d.className='figure-row';
  d.innerHTML=`
    <input placeholder="Image" value="${src}">
    <input placeholder="L√©gende" value="${caption}">
    <button onclick="this.parentElement.remove()">‚ùå</button>`;
  figures.appendChild(d);
}

/* ===================== LECTURE ARTICLE ===================== */
async function loadArticle(i){
  if(i==='')return;
  const a=articles[i];
  title.value=a.title;
  file.value=a.file;
  rueId.value=a.rueId??'';
  periode.value=a.periode;
  famille.value=a.famille??'';
  theme.value=a.theme;

  try{
    const html=await fetch('articles/content/'+a.file).then(r=>r.text());
    htmlOut.value=html;
    preview.srcdoc=buildPreview(html);
  }catch{}
}

/* ===================== G√âN√âRATION ===================== */
function generate(){
  const figs=[...figures.children].map(d=>({
    src:d.children[0].value,
    caption:d.children[1].value
  }));

  const fragment=generateFragment({
    title:title.value,
    description:description.value,
    figures:figs,
    body:body.value
  });

  htmlOut.value=fragment;

  const entry={
    title:title.value,
    file:file.value,
    rueId:rueId.value!==''?Number(rueId.value):null,
    periode:Number(periode.value),
    famille:famille.value!==''?Number(famille.value):null,
    theme:Number(theme.value),
    image:figs[0]?.src||null,
    video:null
  };

  jsonOut.value=JSON.stringify(entry,null,2);
  optionsOut.value=JSON.stringify(options,null,2);
  preview.srcdoc=buildPreview(fragment);

  downloads.innerHTML='';
  download(fragment,file.value,'text/html');
  download(JSON.stringify(entry,null,2),'article.json','application/json');
  download(JSON.stringify(options,null,2),'options.json','application/json');
}

/* ===================== FRAGMENT / PREVIEW ===================== */
function generateFragment(d){
return `<article class="article-fragment">
<section class="article-body">
<h1>${d.title}</h1>
${d.description?`<p class="date">${d.description}</p>`:''}
${d.figures.map(f=>`
<figure>
<img src="${f.src}">
${f.caption?`<figcaption>${f.caption}</figcaption>`:''}
</figure>`).join('')}
${d.body.split(/\n\s*\n/).map(p=>`<p>${p}</p>`).join('')}
</section>
</article>`;
}

function buildPreview(fragment){
return `<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">
</head><body>
<main style="max-width:900px;margin:auto">${fragment}</main>
</body></html>`;
}

function download(c,n,t){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([c],{type:t}));
  a.download=n;
  a.click();
}
</script>
</body>
</html>
