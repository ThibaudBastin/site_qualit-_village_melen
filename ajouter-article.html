<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Administration ‚Äì Articles</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
input, textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}
textarea { height: 160px; }
button { padding: 10px; margin-right: 10px; }
.preview img, .preview video {
  max-width: 100%;
  margin-top: 10px;
}
.hidden { display:none; }
hr { margin: 30px 0; }
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
  <h2>üîê Acc√®s administrateur</h2>
  <input id="pinInput" type="password" placeholder="Code PIN">
  <button onclick="login()">Connexion</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminBox" class="hidden">

<h1>‚úçÔ∏è Ajouter / Modifier un article</h1>

<hr>

<h2>üó∫Ô∏è Lieu</h2>
<input id="rueId" placeholder="Identifiant du lieu (ex: arbre-biscuit)">
<input id="rueNom" placeholder="Nom du lieu">

<p><strong>NOUVEAU LIEU ?</strong></p>
<input id="lat" placeholder="Latitude">
<input id="lng" placeholder="Longitude">

<p><em>Laisse latitude/longitude vides si le lieu existe d√©j√†</em></p>

<hr>

<h2>üìù Article</h2>
<input id="title" placeholder="Titre">
<input id="file" placeholder="Fichier HTML (Article-xxx.html)">
<input id="periode" placeholder="P√©riode">
<input id="famille" placeholder="Famille (optionnel)">
<input id="theme" placeholder="Th√®me">
<input id="image" placeholder="Chemin image">
<input id="video" placeholder="Chemin vid√©o">
<textarea id="content" placeholder="Texte de l‚Äôarticle"></textarea>

<div class="preview" id="preview"></div>

<hr>

<button onclick="generate()">üì¶ G√©n√©rer fichiers</button>

<p>
<a id="dlHtml" download style="display:none">‚¨á HTML article</a><br>
<a id="dlArticle" download style="display:none">‚¨á JSON article</a><br>
<a id="dlLieux" download style="display:none">‚¨á lieux.json (mis √† jour)</a>
</p>

<p><a href="index.html">‚¨Ö Retour au site</a></p>

</div>

<script>
/* ================= CONFIG ================= */
const ADMIN_PIN = "1234";

/* ================= LOGIN ================= */
function login() {
  if (pinInput.value === ADMIN_PIN) {
    localStorage.setItem("admin", "ok");
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
  } else {
    alert("Code incorrect");
  }
}
if (localStorage.getItem("admin") === "ok") {
  loginBox.classList.add("hidden");
  adminBox.classList.remove("hidden");
}

/* ================= PREVIEW ================= */
function updatePreview() {
  preview.innerHTML = "";
  if (video.value) {
    preview.innerHTML = `<video controls src="${video.value}"></video>`;
  } else if (image.value) {
    preview.innerHTML = `<img src="${image.value}">`;
  }
}
image.oninput = updatePreview;
video.oninput = updatePreview;

/* ================= GENERATION ================= */
async function generate() {

  /* === HTML ARTICLE === */
  const html = `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>${title.value}</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
<h1>Groupement Intercommunal</h1>
<nav>
<a href="index.html">Actualit√©s</a>
<a href="articles.html">Articles</a>
<a href="carte.html">Carte</a>
</nav>
</header>

<main>
<section>
<h2>${title.value}</h2>

${video.value
? `<video controls src="${video.value}"></video>`
: `<img src="${image.value}" alt="${title.value}">`
}

<p class="date">${periode.value}</p>

<p>${content.value.replace(/\n/g,"</p><p>")}</p>

<div class="article-map-link">
<a href="carte.html?rue=${rueId.value}">üìç Voir sur la carte</a>
</div>

<p><a href="articles.html">‚Üê Retour aux articles</a></p>
</section>
</main>

<footer><p>¬© Qualit√© village Melen</p></footer>
</body>
</html>`;

  /* === JSON ARTICLE === */
  const articleJson = {
    title: title.value,
    file: file.value,
    rueId: rueId.value,
    rueNom: rueNom.value,
    periode: periode.value,
    famille: famille.value || null,
    theme: theme.value,
    image: image.value || null,
    video: video.value || null
  };

  /* === TELECHARGEMENTS === */
  dlHtml.href = URL.createObjectURL(new Blob([html], {type:"text/html"}));
  dlHtml.download = file.value;
  dlHtml.style.display = "inline";

  dlArticle.href = URL.createObjectURL(
    new Blob([JSON.stringify(articleJson, null, 2)], {type:"application/json"})
  );
  dlArticle.download = file.value.replace(".html",".json");
  dlArticle.style.display = "inline";

  /* === LIEUX.JSON === */
  if (lat.value && lng.value) {
    let lieux = [];
    try {
      const res = await fetch("lieux.json");
      lieux = await res.json();
    } catch {}

    lieux.push({
      id: rueId.value,
      nom: rueNom.value,
      coords: [parseFloat(lat.value), parseFloat(lng.value)]
    });

    dlLieux.href = URL.createObjectURL(
      new Blob([JSON.stringify(lieux, null, 2)], {type:"application/json"})
    );
    dlLieux.download = "lieux.json";
    dlLieux.style.display = "inline";
  }
}
</script>

</body>
</html>
