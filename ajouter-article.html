<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modifier un article – Qualité village Melen</title>
<link rel="stylesheet" href="style.css">

<script>
const PASSWORD = "melen1943";
const userInput = prompt("Mot de passe requis :");
if (userInput !== PASSWORD) {
  document.write("<h2 style='text-align:center;margin-top:3rem;'>Accès refusé</h2>");
  throw new Error("Accès refusé");
}
</script>

<style>
body { font-family: sans-serif; margin: 2rem; }
.form-group { margin-bottom: 1rem; }
label { font-weight: bold; display: block; margin-bottom: .3rem; }
input, textarea, select { width: 100%; padding: .5rem; }
button { padding: .6rem 1rem; margin-top: 1rem; cursor: pointer; }
.preview img, video { max-width: 100%; margin-top: 1rem; border-radius: 6px; }
iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 1rem; }
.downloads a { display: inline-block; margin-right: 1rem; margin-top: .5rem; }
</style>
</head>
<body>

<header>
<h1>Modifier un article</h1>
</header>

<main>
<section>

<div class="form-group">
  <label>Choisir un article à modifier</label>
  <select id="articleSelect">
    <option value="">-- Sélectionner un article --</option>
  </select>
</div>

<!-- FORMULAIRE -->
<div class="form-group">
  <label>Titre</label>
  <input id="title">
</div>

<div class="form-group">
  <label>Nom du fichier HTML</label>
  <input id="file" placeholder="Article-mon-article.html">
</div>

<div class="form-group">
  <label>Rue (ID)</label>
  <select id="rueId"></select>
  <input id="newRue" placeholder="Nouvelle rue ID" style="margin-top:.5rem;">
  <button onclick="addOption('rue')">Ajouter nouvelle rue</button>
</div>

<div class="form-group">
  <label>Nom complet du lieu</label>
  <input id="rueNom">
</div>

<div class="form-group">
  <label>Période</label>
  <select id="periode"></select>
  <input id="newPeriode" placeholder="Nouvelle période" style="margin-top:.5rem;">
  <button onclick="addOption('periode')">Ajouter nouvelle période</button>
</div>

<div class="form-group">
  <label>Famille</label>
  <select id="famille"></select>
  <input id="newFamille" placeholder="Nouvelle famille" style="margin-top:.5rem;">
  <button onclick="addOption('famille')">Ajouter nouvelle famille</button>
</div>

<div class="form-group">
  <label>Thème</label>
  <select id="theme"></select>
  <input id="newTheme" placeholder="Nouveau thème" style="margin-top:.5rem;">
  <button onclick="addOption('theme')">Ajouter nouveau thème</button>
</div>

<div class="form-group">
  <label>Image (chemin)</label>
  <input id="image" placeholder="images/photo.jpg" oninput="previewMedia()">
</div>

<div class="form-group">
  <label>Vidéo (chemin mp4 – optionnel)</label>
  <input id="video" placeholder="videos/video.mp4" oninput="previewMedia()">
</div>

<div class="form-group">
  <label>Texte de l’article</label>
  <textarea id="content" rows="10"></textarea>
</div>

<button onclick="generate()">Générer / Mettre à jour</button>

<div class="preview" id="mediaPreview"></div>

<hr>

<h3>Prévisualisation HTML</h3>
<iframe id="htmlPreview"></iframe>

<hr>

<h3>Fichier JSON</h3>
<textarea id="jsonOutput" rows="10"></textarea>

<h3>Fichier HTML</h3>
<textarea id="htmlOutput" rows="15"></textarea>

<div class="downloads" id="downloads"></div>

</section>
</main>

<script>
let options = { rues: [], periodes: [], familles: [], themes: [] };
let articles = [];

// Charger options.json et articles.json au démarrage
(async function loadData() {
  try {
    const [optRes, artRes] = await Promise.all([
      fetch('options.json'),
      fetch('articles.json')
    ]);
    options = await optRes.json();
    articles = await artRes.json();
    populateSelects();
    populateArticleSelect();
  } catch (err) {
    console.error('Erreur chargement options/articles :', err);
  }
})();

// Remplir les listes déroulantes (rues, périodes, familles, thèmes)
function populateSelects() {
  fillSelect('selectRue', options.rues, '— Choisir une rue —');
  fillSelect('selectPeriode', options.periodes, '— Choisir une période —');
  fillSelect('selectFamille', options.familles, '— Choisir une famille —');
  fillSelect('selectTheme', options.themes, '— Choisir un thème —');
}

function fillSelect(id, arr, placeholder) {
  const sel = document.getElementById(id);
  if (!sel) return;
  sel.innerHTML = '';
  const opt = document.createElement('option');
  opt.value = '';
  opt.textContent = placeholder;
  sel.appendChild(opt);
  (arr || []).forEach((label, i) => {
    const o = document.createElement('option');
    o.value = String(i);
    o.textContent = label;
    sel.appendChild(o);
  });
}

// Préparer le menu des articles (sélecteur) pour modification
function populateArticleSelect() {
  let sel = document.getElementById('articleSelect');
  // si pas présent, on le crée juste sous le label "Choisir un article à modifier"
  if (!sel) {
    const container = document.querySelector('main section') || document.body;
    const grp = document.createElement('div');
    grp.className = 'form-group';
    const label = document.createElement('label');
    label.textContent = 'Choisir un article à modifier';
    sel = document.createElement('select');
    sel.id = 'articleSelect';
    grp.appendChild(label);
    grp.appendChild(sel);
    // insérer en haut du formulaire
    const firstFormGroup = container.querySelector('.form-group');
    if (firstFormGroup) container.insertBefore(grp, firstFormGroup);
    else container.appendChild(grp);
  }

  sel.innerHTML = '';
  const empty = document.createElement('option');
  empty.value = '';
  empty.textContent = '— Nouveau / sélectionner —';
  sel.appendChild(empty);

  (articles || []).forEach((a, i) => {
    const o = document.createElement('option');
    // on utilise l'index comme valeur pour retrouver facilement l'article
    o.value = String(i);
    o.textContent = a.title || a.file || `Article ${i}`;
    sel.appendChild(o);
  });

  sel.addEventListener('change', async function () {
    if (!this.value) {
      clearForm();
      return;
    }
    const idx = Number(this.value);
    await loadArticleByIndex(idx);
  });
}

// récupère (ou utilise en mémoire) articles.json puis charge l'article choisi
async function loadArticleByIndex(idx) {
  try {
    if (!Array.isArray(articles) || articles.length === 0) {
      const res = await fetch('articles.json');
      articles = await res.json();
      populateArticleSelect(); // re-populate si nécessaire
    }
    const article = articles[idx];
    if (!article) return;
    fillFormFromArticle(article);
  } catch (err) {
    console.error('Erreur récupération article:', err);
  }
}

// Remplit le formulaire avec les données de l'article si les champs existent
function fillFormFromArticle(a) {
  // champs attendus (ajustez les ids si nécessaires)
  const map = {
    'title': a.title,
    'file': a.file,
    'image': a.image,
    'video': a.video,
    'selectRue': a.rueId != null ? String(a.rueId) : '',
    'selectPeriode': a.periode != null ? String(a.periode) : '',
    'selectFamille': a.famille != null ? String(a.famille) : '',
    'selectTheme': a.theme != null ? String(a.theme) : '',
    'content': a.content || '' // si vous stockez corps d'article
  };

  Object.keys(map).forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
      el.value = map[id] ?? '';
      // déclencher event change pour éventuels handlers
      el.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });

  // Média preview si présent
  const preview = document.getElementById('mediaPreview');
  if (preview) {
    preview.innerHTML = '';
    if (a.video) {
      const v = document.createElement('video');
      v.controls = true;
      v.src = a.video;
      v.style.maxWidth = '100%';
      preview.appendChild(v);
    } else if (a.image) {
      const img = document.createElement('img');
      img.src = a.image;
      img.style.maxWidth = '100%';
      preview.appendChild(img);
    }
  }

  // remplir les zones JSON / HTML si la page gére cela
  const jsonOut = document.getElementById('jsonOutput');
  if (jsonOut) jsonOut.value = JSON.stringify(a, null, 2);
}

// vide le formulaire minimalement
function clearForm() {
  ['title','file','image','video','content'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  ['selectRue','selectPeriode','selectFamille','selectTheme'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const preview = document.getElementById('mediaPreview');
  if (preview) preview.innerHTML = '';
  const jsonOut = document.getElementById('jsonOutput');
  if (jsonOut) jsonOut.value = '';
}
</script>
</body>
</html>
