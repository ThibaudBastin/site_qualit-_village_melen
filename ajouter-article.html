<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modifier un article ‚Äì Qualit√© village Melen</title>
<link rel="stylesheet" href="style.css">

<script>
const PASSWORD = "melen1943";
const userInput = prompt("Mot de passe requis :");
if (userInput !== PASSWORD) {
  document.write("<h2 style='text-align:center;margin-top:3rem;'>Acc√®s refus√©</h2>");
  throw new Error("Acc√®s refus√©");
}
</script>

<style>
body { font-family: sans-serif; margin: 2rem; }
.form-group { margin-bottom: 1rem; }
label { font-weight: bold; display: block; margin-bottom: .3rem; }
input, textarea, select { width: 100%; padding: .5rem; }
button { padding: .6rem 1rem; margin-top: 1rem; cursor: pointer; }
.preview img, video { max-width: 100%; margin-top: 1rem; border-radius: 6px; }
iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 1rem; }
.downloads a { display: inline-block; margin-right: 1rem; margin-top: .5rem; }
</style>
</head>
<body>

<header>
<h1>Modifier un article</h1>
</header>

<main>
<section>

<div class="form-group">
  <label>Choisir un article √† modifier</label>
  <select id="articleSelect">
    <option value="">-- S√©lectionner un article --</option>
  </select>
</div>

<!-- FORMULAIRE -->
<div class="form-group">
  <label>Titre</label>
  <input id="title">
</div>

<div class="form-group">
  <label>Nom du fichier HTML</label>
  <input id="file" placeholder="Article-mon-article.html">
</div>

<div class="form-group">
  <label>Rue (ID)</label>
  <select id="rueId"></select>
  <input id="newRue" placeholder="Nouvelle rue ID" style="margin-top:.5rem;">
  <button onclick="addOption('rue')">Ajouter nouvelle rue</button>
</div>

<div class="form-group">
  <label>Nom complet du lieu</label>
  <input id="rueNom">
</div>

<div class="form-group">
  <label>P√©riode</label>
  <select id="periode"></select>
  <input id="newPeriode" placeholder="Nouvelle p√©riode" style="margin-top:.5rem;">
  <button onclick="addOption('periode')">Ajouter nouvelle p√©riode</button>
</div>

<div class="form-group">
  <label>Famille</label>
  <select id="famille"></select>
  <input id="newFamille" placeholder="Nouvelle famille" style="margin-top:.5rem;">
  <button onclick="addOption('famille')">Ajouter nouvelle famille</button>
</div>

<div class="form-group">
  <label>Th√®me</label>
  <select id="theme"></select>
  <input id="newTheme" placeholder="Nouveau th√®me" style="margin-top:.5rem;">
  <button onclick="addOption('theme')">Ajouter nouveau th√®me</button>
</div>

<div class="form-group">
  <label>Image (chemin)</label>
  <input id="image" placeholder="images/photo.jpg" oninput="previewMedia()">
</div>

<div class="form-group">
  <label>Vid√©o (chemin mp4 ‚Äì optionnel)</label>
  <input id="video" placeholder="videos/video.mp4" oninput="previewMedia()">
</div>

<div class="form-group">
  <label>Texte de l‚Äôarticle</label>
  <textarea id="content" rows="10"></textarea>
</div>

<button onclick="generate()">G√©n√©rer / Mettre √† jour</button>

<div class="preview" id="mediaPreview"></div>

<hr>

<h3>Pr√©visualisation HTML</h3>
<iframe id="htmlPreview"></iframe>

<hr>

<h3>Fichier JSON</h3>
<textarea id="jsonOutput" rows="10"></textarea>

<h3>Fichier HTML</h3>
<textarea id="htmlOutput" rows="15"></textarea>

<div class="downloads" id="downloads"></div>

</section>
</main>

<script>
let options = { rues: [], periodes: [], familles: [], themes: [] };
let articles = [];

// Charger options.json et articles.json
Promise.all([
  fetch('options.json').then(r => r.json()),
  fetch('articles.json').then(r => r.json())
]).then(([optData, artData]) => {
  options = optData;
  articles = artData;
  populateSelects();
  populateArticleSelect();
});

// Remplir les listes d√©roulantes
function populateSelects() {
  fillSelect('rueId', options.rues);
  fillSelect('periode', options.periodes);
  fillSelect('famille', options.familles);
  fillSelect('theme', options.themes);
}

function fillSelect(id, arr) {
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">-- choisir --</option>';
  arr.forEach((item, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = item;
    sel.appendChild(opt);
  });
}

// Ajouter nouvelle option
function addOption(type) {
  const inputId = type==='rue'?'newRue':type==='periode'?'newPeriode':type==='famille'?'newFamille':'newTheme';
  const val = document.getElementById(inputId).value.trim();
  if(!val) return;
  options[type + (type==='rue'?'s':type==='theme'?'s':'')].push(val);
  populateSelects();
  document.getElementById(inputId).value='';
}

// Pr√©visualisation m√©dia
function previewMedia() {
  const p = document.getElementById("mediaPreview");
  p.innerHTML = "";
  const imgVal = document.getElementById("image").value;
  const vidVal = document.getElementById("video").value;
  if (vidVal) p.innerHTML = `<video controls src="${vidVal}"></video>`;
  else if (imgVal) p.innerHTML = `<img src="${imgVal}">`;
}

// Pr√©parer menu des articles
function populateArticleSelect() {
  const sel = document.getElementById("articleSelect");
  articles.forEach((art,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = art.title;
    sel.appendChild(opt);
  });
}

// Quand on choisit un article
document.getElementById("articleSelect").addEventListener('change', function(){
  const idx = this.value;
  if(idx==='') return;
  const art = articles[idx];
  document.getElementById("title").value = art.title;
  document.getElementById("file").value = art.file;
  document.getElementById("rueNom").value = art.rueNom||'';
  document.getElementById("rueId").value = art.rueId ? options.rues.indexOf(art.rueId) : '';
  document.getElementById("periode").value = art.periode ? options.periodes.indexOf(art.periode) : '';
  document.getElementById("famille").value = art.famille ? options.familles.indexOf(art.famille) : '';
  document.getElementById("theme").value = art.theme ? options.themes.indexOf(art.theme) : '';
  document.getElementById("image").value = art.image||'';
  document.getElementById("video").value = art.video||'';
  
  // Charger le HTML du texte
  if(art.file){
    fetch(art.file).then(r=>r.text()).then(txt=>{
      document.getElementById("content").value = txt.replace(/<[^>]+>/g,'').trim();
    });
  }
  previewMedia();
});

// G√©n√©ration HTML + JSON
function generate() {
  const t = document.getElementById("title").value;
  const f = document.getElementById("file").value;
  const rId = document.getElementById("rueId").value;
  const rNom = document.getElementById("rueNom").value;
  const peri = document.getElementById("periode").value;
  const fam = document.getElementById("famille").value;
  const th = document.getElementById("theme").value;
  const img = document.getElementById("image").value;
  const vid = document.getElementById("video").value;
  const cont = document.getElementById("content").value;

  const paragraphs = cont.split(/\n\s*\n/).map(p=>`<p>${p.trim()}</p>`).join("\n");

  let media = "";
  if(vid) media = `<video controls><source src="${vid}" type="video/mp4"></video>`;
  else if(img) media = `<figure><img src="${img}" alt="${t}"></figure>`;

  const mapBtn = rId ? `<div class="article-map-link"><a href="carte.html?rue=${options.rues[rId]}" class="map-button">üìç Voir ce lieu sur la carte</a></div>` : "";

  const html = `<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>${t}</title><link rel="stylesheet" href="style.css"></head>
<body>
<header><h1>Qualit√© village Melen</h1>
<nav><a href="index.html">Actualit√©s</a><a href="articles.html">Articles</a><a href="carte.html">Carte</a><a href="agenda.html">Agenda</a></nav></header>
<main><section><h2>${t}</h2>${media}${paragraphs}${mapBtn}
<p><a href="articles.html">‚Üê Retour aux articles</a></p></section></main>
<footer><p>¬© 2025 ‚Äì Qualit√© village Melen</p></footer>
</body></html>`;

  const json = {
    title: t,
    file: f,
    rueId: rId ? options.rues[rId] : null,
    rueNom: rNom||null,
    periode: peri ? options.periodes[peri] : null,
    famille: fam ? options.familles[fam] : null,
    theme: th ? options.themes[th] : null,
    image: img||null,
    video: vid||null
  };

  document.getElementById("htmlPreview").srcdoc = html;
  document.getElementById("jsonOutput").value = JSON.stringify(json,null,2);
  document.getElementById("htmlOutput").value = html;

  document.getElementById("downloads").innerHTML = `
<a download="${f}" href="data:text/html;charset=utf-8,${encodeURIComponent(html)}">‚¨á T√©l√©charger HTML</a>
<a download="${f.replace('.html','.json')}" href="data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(json,null,2))}">‚¨á T√©l√©charger JSON</a>
`;
}
</script>
</body>
</html>
